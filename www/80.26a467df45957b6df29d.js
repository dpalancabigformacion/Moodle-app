(window.webpackJsonp=window.webpackJsonp||[]).push([[80],{u5Wa:function(i,t,e){"use strict";e.r(t),e.d(t,"AddonModWikiLazyModule",(function(){return Xi}));var o=e("tyNb"),a=e("L3Fv"),d=e("QowF"),n=e("9Hu0"),s=e("ekpb"),r=e("MLi9"),c=e("mrSG"),l=e("93ts"),h=e("ULAo"),u=e("pHTc"),g=e("9+EE"),I=e("uT8i"),m=e("3LXp"),k=e("vuGA"),p=e("bFG1"),b=e("j3ag"),w=e("fjkH"),f=e("4reR"),E=e("IfL8"),P=e("JZ+O"),v=e("NH8Q"),M=e("fXoL"),y=e("3Pt+"),_=e("TEn/"),A=e("hMzs"),D=e("ACYt"),L=e("nt/U"),T=e("PgjG"),C=e("ofXK"),x=e("N5Lt"),F=e("sYmb");const O=["editPageForm"];function AddonModWikiEditPage_form_14_ion_item_2_Template(i,t){1&i&&(M.Ec(0,"ion-item",13),M.Ec(1,"ion-label",10),M.pd(2),M.Pc(3,"translate"),M.Dc(),M.zc(4,"ion-input",14),M.Pc(5,"translate"),M.Dc()),2&i&&(M.lc(2),M.qd(M.Qc(3,2,"addon.mod_wiki.newpagetitle")),M.lc(2),M.Vc("placeholder",M.Qc(5,4,"addon.mod_wiki.newpagetitle")))}function AddonModWikiEditPage_form_14_ion_item_9_Template(i,t){1&i&&(M.Ec(0,"ion-item",15),M.Ec(1,"ion-label"),M.Ec(2,"ion-badge",16),M.pd(3),M.Pc(4,"translate"),M.Dc(),M.Dc(),M.Dc()),2&i&&(M.lc(3),M.qd(M.Qc(4,1,"addon.mod_wiki.wrongversionlock")))}function AddonModWikiEditPage_form_14_Template(i,t){if(1&i&&(M.Ec(0,"form",7,8),M.nd(2,AddonModWikiEditPage_form_14_ion_item_2_Template,6,6,"ion-item",9),M.Ec(3,"ion-item"),M.Ec(4,"ion-label",10),M.pd(5),M.Pc(6,"translate"),M.Dc(),M.zc(7,"core-rich-text-editor",11),M.Pc(8,"translate"),M.Dc(),M.nd(9,AddonModWikiEditPage_form_14_ion_item_9_Template,5,3,"ion-item",12),M.Dc()),2&i){const i=M.Oc();M.Vc("formGroup",i.pageForm),M.lc(2),M.Vc("ngIf",i.canEditTitle),M.lc(3),M.qd(M.Qc(6,11,"core.content")),M.lc(2),M.Vc("control",i.contentControl)("placeholder",M.Qc(8,13,"core.content"))("component",i.component)("componentId",i.cmId)("autoSave",!0)("contextInstanceId",i.cmId)("draftExtraParams",i.editorExtraParams),M.lc(2),M.Vc("ngIf",i.wrongVersionLock)}}let W=(()=>{class AddonModWikiEditPage{constructor(i){this.formBuilder=i,this.canEditTitle=!1,this.loaded=!1,this.component=E.b.COMPONENT,this.wrongVersionLock=!1,this.editorExtraParams={},this.editing=!1,this.editOffline=!1,this.subwikiFiles=[],this.forceLeave=!1,this.isDestroyed=!1}ngOnInit(){return Object(c.a)(this,void 0,void 0,(function*(){this.cmId=u.a.getRouteNumberParam("cmId")||void 0,this.courseId=u.a.getRouteNumberParam("courseId")||void 0,this.subwikiId=u.a.getRouteNumberParam("subwikiId"),this.wikiId=u.a.getRouteNumberParam("wikiId"),this.pageId=u.a.getRouteNumberParam("pageId"),this.section=u.a.getRouteParam("section"),this.groupId=u.a.getRouteNumberParam("groupId"),this.userId=u.a.getRouteNumberParam("userId");let i=u.a.getRouteParam("pageTitle");i=i?i.replace(/\+/g," "):"",this.canEditTitle=!i,this.title=i?b.M.instant("addon.mod_wiki.editingpage",{$a:i}):b.M.instant("addon.mod_wiki.newpagehdr"),this.blockId=v.a.getSubwikiBlockId(this.subwikiId,this.wikiId,this.userId,this.groupId),this.contentControl=this.formBuilder.control(""),this.pageForm=this.formBuilder.group({title:i}),this.pageForm.addControl("text",this.contentControl),I.a.blockOperation(this.component,this.blockId),this.pageId?(this.editorExtraParams.pageid=this.pageId,this.section&&(this.editorExtraParams.section=this.section)):i&&(this.editorExtraParams.pagetitle=i);try{if((yield this.fetchWikiPageData())&&!this.isDestroyed){const i=v.a.getSubwikiBlockId(this.subwikiId,this.wikiId,this.userId,this.groupId);i!=this.blockId&&(I.a.unblockOperation(this.component,this.blockId),this.blockId=i,I.a.blockOperation(this.component,this.blockId))}}finally{this.loaded=!0}}))}fetchWikiPageData(){return Object(c.a)(this,void 0,void 0,(function*(){let i=!1,t=!1;try{const e=yield v.a.waitForSync(this.blockId);if(this.pageId){this.canEditTitle=!1,this.editing=!0,this.editOffline=!1;const t=yield E.a.getPageContents(this.pageId,{cmId:this.cmId});this.pageForm.controls.title.setValue(t.title),this.wikiId=t.wikiid,this.subwikiId=t.subwikiid,this.title=b.M.instant("addon.mod_wiki.editingpage",{$a:t.title}),this.groupId=t.groupid,this.userId=t.userid,i=t.caneditpage,yield this.fetchModuleAndCourseId(),this.subwikiFiles=yield E.a.getSubwikiFiles(this.wikiId,{groupId:this.groupId,userId:this.userId,cmId:this.cmId});const e=yield E.a.getPageForEditing(this.pageId,this.section),o=k.a.replacePluginfileUrls(e.content||"",this.subwikiFiles);this.contentControl.setValue(o),this.originalContent=o,this.version=e.version,i&&(this.renewLockInterval=window.setInterval((()=>{this.renewLock()}),E.b.RENEW_LOCK_TIME))}else{const t=this.pageForm.controls.title.value;if(this.editing=!1,i=!!this.blockId,yield this.fetchModuleAndCourseId(),!this.wikiId&&this.cmId&&this.courseId){const i=yield h.a.getModule(this.cmId,this.courseId,void 0,!0);this.wikiId=i.instance}if(t){if(e){const i=e.created.find((i=>i.title==t));if(i&&i.pageId>0)return this.pageId=i.pageId,this.fetchWikiPageData()}const i=yield p.a.ignoreErrors(P.a.getNewPage(t,this.subwikiId,this.wikiId,this.userId,this.groupId));i?(this.contentControl.setValue(i.cachedcontent),this.originalContent=i.cachedcontent,this.editOffline=!0):this.editOffline=!1}else this.editOffline=!1}return!0}catch(i){return m.a.showErrorModalDefault(i,"Error getting wiki data."),t=!0,this.forceLeavePage(),!1}finally{i||t||(m.a.showAlert(b.M.instant("core.notice"),b.M.instant("addon.mod_wiki.cannoteditpage")),this.forceLeavePage())}}))}fetchModuleAndCourseId(){return Object(c.a)(this,void 0,void 0,(function*(){if(!this.wikiId||this.cmId&&this.courseId)return;const i=yield h.a.getModuleBasicInfoByInstance(this.wikiId,"wiki",{readingStrategy:1});this.cmId=i.id,this.courseId=i.course}))}forceLeavePage(){this.forceLeave=!0,u.a.back()}goToPage(i){E.a.setEditedPageData({cmId:this.cmId,courseId:this.courseId,pageId:this.pageId,pageTitle:i,wikiId:this.wikiId,subwikiId:this.subwikiId,userId:this.userId,groupId:this.groupId}),this.forceLeavePage()}hasDataChanged(){const i=this.pageForm.value;return!(this.originalContent==i.text||!this.editing&&!i.text&&!i.title)}canLeave(){return Object(c.a)(this,void 0,void 0,(function*(){return this.forceLeave||(this.hasDataChanged()&&(yield m.a.showConfirm(b.M.instant("core.confirmcanceledit"))),f.a.triggerFormCancelledEvent(this.formElement,g.b.getCurrentSiteId())),!0}))}ionViewDidLeave(){setTimeout((()=>{E.a.consumeEditedPageData()}),200)}save(){return Object(c.a)(this,void 0,void 0,(function*(){const i=this.pageForm.value,t=i.title;let e=i.text;const o=yield m.a.showModalLoading("core.sending",!0);e=k.a.restorePluginfileUrls(e,this.subwikiFiles),e=k.a.formatHtmlLines(e);try{if(this.editing)return yield E.a.editPage(this.pageId,e,this.section),f.a.triggerFormSubmittedEvent(this.formElement,!0,g.b.getCurrentSiteId()),yield E.a.invalidatePage(this.pageId),this.goToPage(t);if(!t)return o.dismiss(),m.a.showAlert(b.M.instant("core.notice"),b.M.instant("addon.mod_wiki.titleshouldnotbeempty")),void 0;if(!this.editOffline){if(yield p.a.ignoreErrors(P.a.getNewPage(t,this.subwikiId,this.wikiId,this.userId,this.groupId)))throw new l.a(b.M.instant("addon.mod_wiki.pageexists"))}const i=yield E.a.newPage(t,e,{subwikiId:this.subwikiId,wikiId:this.wikiId,userId:this.userId,groupId:this.groupId,cmId:this.cmId});if(f.a.triggerFormSubmittedEvent(this.formElement,i>0,g.b.getCurrentSiteId()),i<=0)return this.goToPage(t);w.b.trigger(w.b.ACTIVITY_DATA_SENT,{module:"wiki"}),this.pageId=i;const a=yield E.a.getPageContents(this.pageId,{cmId:this.cmId}),d=[];this.wikiId=a.wikiid,d.push(E.a.invalidateSubwikiPages(this.wikiId)),this.subwikiId||d.push(E.a.invalidateSubwikis(this.wikiId)),this.subwikiId=a.subwikiid,this.userId=a.userid,this.groupId=a.groupid,yield p.a.ignoreErrors(Promise.all(d)),w.b.trigger(E.b.PAGE_CREATED_EVENT,{pageId:this.pageId,subwikiId:this.subwikiId,pageTitle:t},g.b.getCurrentSiteId()),this.goToPage(t)}catch(i){m.a.showErrorModalDefault(i,"Error saving wiki data.")}finally{o.dismiss()}}))}renewLock(){return Object(c.a)(this,void 0,void 0,(function*(){const i=yield E.a.getPageForEditing(this.pageId,this.section,!0);i.version&&this.version!=i.version&&(this.wrongVersionLock=!0)}))}ngOnDestroy(){this.isDestroyed=!0,clearInterval(this.renewLockInterval),this.blockId&&I.a.unblockOperation(this.component,this.blockId)}}return AddonModWikiEditPage.ɵfac=function AddonModWikiEditPage_Factory(i){return new(i||AddonModWikiEditPage)(M.yc(y.f))},AddonModWikiEditPage.ɵcmp=M.sc({type:AddonModWikiEditPage,selectors:[["page-addon-mod-wiki-edit"]],viewQuery:function AddonModWikiEditPage_Query(i,t){var e;(1&i&&M.ud(O,!0),2&i)&&(M.dd(e=M.Nc())&&(t.formElement=e.first))},decls:15,vars:11,consts:[["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end"],["fill","clear",3,"click"],[3,"hideUntil"],[3,"formGroup",4,"ngIf"],[3,"formGroup"],["editPageForm",""],["class","ion-text-wrap",4,"ngIf"],[1,"sr-only"],["name","wiki_page_content","contextLevel","module","elementId","newcontent_editor",3,"control","placeholder","component","componentId","autoSave","contextInstanceId","draftExtraParams"],["class","ion-text-center addon-mod_wiki-wrongversionlock",4,"ngIf"],[1,"ion-text-wrap"],["name","title","type","text","formControlName","title",3,"placeholder"],[1,"ion-text-center","addon-mod_wiki-wrongversionlock"],["color","danger",1,"ion-padding"]],template:function AddonModWikiEditPage_Template(i,t){1&i&&(M.Ec(0,"ion-header"),M.Ec(1,"ion-toolbar"),M.Ec(2,"ion-buttons",0),M.zc(3,"ion-back-button",1),M.Pc(4,"translate"),M.Dc(),M.Ec(5,"ion-title"),M.Ec(6,"h1"),M.zc(7,"core-format-text",2),M.Dc(),M.Dc(),M.Ec(8,"ion-buttons",3),M.Ec(9,"ion-button",4),M.Mc("click",(function AddonModWikiEditPage_Template_ion_button_click_9_listener(){return t.save()})),M.pd(10),M.Pc(11,"translate"),M.Dc(),M.Dc(),M.Dc(),M.Dc(),M.Ec(12,"ion-content"),M.Ec(13,"core-loading",5),M.nd(14,AddonModWikiEditPage_form_14_Template,10,15,"form",6),M.Dc(),M.Dc()),2&i&&(M.lc(3),M.Vc("text",M.Qc(4,7,"core.back")),M.lc(4),M.Vc("text",t.title)("contextInstanceId",t.cmId)("courseId",t.courseId),M.lc(3),M.rd(" ",M.Qc(11,9,"core.save")," "),M.lc(3),M.Vc("hideUntil",t.loaded),M.lc(1),M.Vc("ngIf",t.loaded))},directives:[_.C,_.Ab,_.m,_.h,_.i,_.yb,A.a,D.a,_.l,L.a,_.v,T.a,C.t,y.H,y.s,y.k,_.I,_.O,x.a,_.H,_.Pb,y.r,y.i,_.k],pipes:[F.d],encapsulation:2}),AddonModWikiEditPage})();var N=e("M9y5"),S=e("aEIl"),z=e("3zv0"),V=e("Lmwl"),j=e("4qNr"),Q=e("fQ68"),R=e("8/N+"),J=e("0QZc"),H=e("uHIS"),G=e("w+Pn"),q=e("r8G5"),B=e("5450"),U=e("W5pS"),K=e("p+Qc"),Y=e("qNqN"),X=e("xpMl"),Z=e("FTxb"),$=e("/K1O"),ii=e("FasJ"),ti=e("eAud"),ei=e("ACV2"),oi=e("/BoF"),ai=e("TKc2"),di=e("whRm"),ni=e("O4u7"),si=e("lqoc"),ri=e("3lz8"),ci=e("46ml"),li=e("QQhE"),hi=e("MpCO"),ui=e("JYLr"),gi=e("vWwc"),Ii=e("NhJP"),mi=e("rztj"),ki=e("FeAf"),pi=e("rf3J"),bi=e("nEkO"),wi=e("TF0o"),fi=e("p5uK"),Ei=e("6uVz"),Pi=e("d0nH"),vi=e("NcPy"),Mi=e("yNDK"),yi=e("3CSS"),_i=e("iSJP"),Ai=e("iJls"),Di=e("ArDJ"),Li=e("nu3w"),Ti=e("saTE"),Ci=e("8PoL"),xi=e("4a38"),Fi=e("4JiN"),Oi=e("OZH1"),Wi=e("edOc"),Ni=e("3jOR"),Si=e("6A9T"),zi=e("nKjD"),Vi=e("MqDN"),ji=e("IBMc"),Qi=e("1iFe"),Ri=e("dne1"),Ji=e("Cg42"),Hi=e("llyR"),Gi=e("uYHD"),qi=e("SspJ"),Bi=e("U2xU"),Ui=e("lAaw"),Ki=e("1ArG");const Yi=[{path:":courseId/:cmId",redirectTo:":courseId/:cmId/page/root"},{path:":courseId/:cmId/page/:hash",component:n.a},{path:":courseId/:cmId/edit",component:W,canDeactivate:[r.a]}];let Xi=(()=>{class AddonModWikiLazyModule{}return AddonModWikiLazyModule.ɵmod=M.wc({type:AddonModWikiLazyModule}),AddonModWikiLazyModule.ɵinj=M.vc({factory:function AddonModWikiLazyModule_Factory(i){return new(i||AddonModWikiLazyModule)},imports:[[o.m.forChild(Yi),a.a,d.a,s.a]]}),AddonModWikiLazyModule})();void(("undefined"==typeof ngJitMode||ngJitMode)&&M.kd(Xi,{declarations:[n.a,W],imports:[o.m,a.a,d.a,s.a]})),M.jd(n.a,[o.n,o.j,o.l,o.k,o.p,C.q,C.r,C.s,C.t,C.A,C.w,C.x,C.y,C.z,C.u,C.v,N.a,S.a,z.a,V.a,j.a,Q.a,R.a,J.a,H.a,G.a,q.a,B.a,U.a,K.a,Y.a,X.a,Z.a,T.a,$.a,ii.a,ti.a,ei.a,oi.a,ai.a,di.a,ni.a,si.a,ri.a,ci.a,li.a,hi.a,ui.a,gi.a,Ii.a,mi.a,ki.a,pi.a,bi.a,wi.a,fi.a,Ei.a,Pi.a,vi.a,Mi.a,yi.a,A.a,_i.a,Ai.a,Di.a,Li.a,Ti.a,Ci.a,xi.a,Fi.b,Oi.a,Wi.a,Ni.a,L.a,D.a,Si.a,y.H,y.w,y.G,y.c,y.x,y.A,y.a,y.D,y.E,y.z,y.r,y.s,y.C,y.o,y.n,y.y,y.b,y.d,y.u,y.v,y.t,_.f,_.g,_.h,_.j,_.k,_.l,_.m,_.n,_.o,_.p,_.q,_.r,_.s,_.t,_.u,_.v,_.w,_.x,_.y,_.z,_.A,_.B,_.C,_.D,_.E,_.F,_.G,_.H,_.I,_.J,_.K,_.L,_.M,_.N,_.O,_.P,_.Q,_.R,_.S,_.T,_.U,_.V,_.W,_.X,_.Y,_.Z,_.ab,_.bb,_.cb,_.db,_.eb,_.fb,_.hb,_.ib,_.jb,_.kb,_.lb,_.mb,_.nb,_.ob,_.pb,_.qb,_.rb,_.sb,_.tb,_.vb,_.wb,_.xb,_.zb,_.Ab,_.yb,_.ub,_.d,_.Jb,_.Mb,_.Ob,_.Pb,_.gb,_.i,_.Hb,_.Nb,_.Rb,_.Sb,_.Tb,_.Bb,y.h,y.k,y.i,y.l,y.e,F.a,zi.a,Vi.a,ji.a,x.a,n.a,W],[C.b,C.G,C.p,C.k,C.E,C.g,C.C,C.F,C.d,C.f,C.i,C.j,C.l,Qi.a,Ri.a,Ji.a,Hi.a,Gi.a,qi.a,Bi.a,Ui.a,Ki.a,F.d])}}]);