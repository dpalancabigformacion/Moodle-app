(window.webpackJsonp=window.webpackJsonp||[]).push([[53],{IODR:function(e,n,t){"use strict";t.r(n),t.d(n,"AddonModChatLazyModule",(function(){return ee}));var o=t("tyNb"),s=t("L3Fv"),a=t("ef6k"),i=t("ghUQ"),d=t("e1dt"),c=t("fXoL"),r=t("TEn/"),g=t("4JiN"),l=t("hMzs"),m=t("nt/U"),_=t("sYmb");let h=(()=>{class AddonModChatIndexPage extends i.a{}return AddonModChatIndexPage.ɵfac=function AddonModChatIndexPage_Factory(e){return u(e||AddonModChatIndexPage)},AddonModChatIndexPage.ɵcmp=c.sc({type:AddonModChatIndexPage,selectors:[["page-addon-mod-chat-index"]],viewQuery:function AddonModChatIndexPage_Query(e,n){var t;(1&e&&c.ud(d.a,!0),2&e)&&(c.dd(t=c.Nc())&&(n.activityComponent=t.first))},features:[c.ic],decls:14,vars:12,consts:[["collapsible",""],["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end"],[1,"limited-width"],["slot","fixed",3,"disabled","ionRefresh"],[3,"pullingText"],[3,"module","courseId","dataRetrieved"]],template:function AddonModChatIndexPage_Template(e,n){1&e&&(c.Ec(0,"ion-header",0),c.Ec(1,"ion-toolbar"),c.Ec(2,"ion-buttons",1),c.zc(3,"ion-back-button",2),c.Pc(4,"translate"),c.Dc(),c.Ec(5,"ion-title"),c.Ec(6,"h1"),c.zc(7,"core-format-text",3),c.Dc(),c.Dc(),c.zc(8,"ion-buttons",4),c.Dc(),c.Dc(),c.Ec(9,"ion-content",5),c.Ec(10,"ion-refresher",6),c.Mc("ionRefresh",(function AddonModChatIndexPage_Template_ion_refresher_ionRefresh_10_listener(e){return null==n.activityComponent?null:n.activityComponent.doRefresh(e.target)})),c.zc(11,"ion-refresher-content",7),c.Pc(12,"translate"),c.Dc(),c.Ec(13,"addon-mod-chat-index",8),c.Mc("dataRetrieved",(function AddonModChatIndexPage_Template_addon_mod_chat_index_dataRetrieved_13_listener(e){return n.updateData(e)})),c.Dc(),c.Dc()),2&e&&(c.lc(3),c.Vc("text",c.Qc(4,8,"core.back")),c.lc(4),c.Vc("text",n.title)("contextInstanceId",null==n.module?null:n.module.id)("courseId",n.courseId),c.lc(3),c.Vc("disabled",null==n.activityComponent?null:n.activityComponent.showLoading),c.lc(1),c.Wc("pullingText",c.Qc(12,10,"core.pulltorefresh")),c.lc(2),c.Vc("module",n.module)("courseId",n.courseId))},directives:[r.C,g.b,r.Ab,r.m,r.h,r.i,r.yb,l.a,m.a,r.v,r.bb,r.cb,d.a],pipes:[_.d],encapsulation:2}),AddonModChatIndexPage})();const u=c.Gc(h);var p=t("mrSG"),f=t("MUy3"),M=t("O4u7"),C=t("nvXB"),P=t("pHTc"),b=t("9+EE"),O=t("3LXp"),v=t("bFG1"),I=t("j3ag"),x=t("fjkH"),A=t("5E3q"),D=t("g4DX"),w=t("btSF"),y=t("ofXK"),T=t("PgjG"),E=t("ACYt"),S=t("3CSS"),k=t("FeAf"),R=t("r8G5"),V=t("uYHD");function AddonModChatChatPage_ion_button_9_Template(e,n){if(1&e){const e=c.Fc();c.Ec(0,"ion-button",14),c.Mc("click",(function AddonModChatChatPage_ion_button_9_Template_ion_button_click_0_listener(){c.fd(e);return c.Oc().showChatUsers()})),c.Pc(1,"translate"),c.zc(2,"ion-icon",15),c.Dc()}2&e&&c.mc("aria-label",c.Qc(1,1,"core.users"))}function AddonModChatChatPage_ng_container_13_p_1_Template(e,n){if(1&e&&(c.Ec(0,"p",19),c.pd(1),c.Pc(2,"coreFormatDate"),c.Dc()),2&e){const e=c.Oc().$implicit;c.lc(1),c.rd(" ",c.Rc(2,1,1e3*e.timestamp,"strftimedayshort")," ")}}const _c0=function(e){return{$a:e}};function AddonModChatChatPage_ng_container_13_div_2_ion_badge_1_Template(e,n){if(1&e&&(c.Ec(0,"ion-badge",26),c.Ec(1,"span"),c.zc(2,"ion-icon",27),c.pd(3),c.Pc(4,"coreFormatDate"),c.Pc(5,"translate"),c.Dc(),c.Dc()),2&e){const e=c.Oc(2).$implicit;c.lc(3),c.sd(" ",c.Rc(4,2,1e3*e.timestamp,"strftimetime")," ",c.Rc(5,5,"addon.mod_chat.messageenter",c.ad(8,_c0,e.userfullname))," ")}}function AddonModChatChatPage_ng_container_13_div_2_ion_badge_2_Template(e,n){if(1&e&&(c.Ec(0,"ion-badge",28),c.Ec(1,"span"),c.zc(2,"ion-icon",29),c.pd(3),c.Pc(4,"coreFormatDate"),c.Pc(5,"translate"),c.Dc(),c.Dc()),2&e){const e=c.Oc(2).$implicit;c.lc(3),c.sd(" ",c.Rc(4,2,1e3*e.timestamp,"strftimetime")," ",c.Rc(5,5,"addon.mod_chat.messageexit",c.ad(8,_c0,e.userfullname))," ")}}function AddonModChatChatPage_ng_container_13_div_2_ion_badge_3_Template(e,n){if(1&e&&(c.Ec(0,"ion-badge",30),c.Ec(1,"span"),c.zc(2,"ion-icon",31),c.pd(3),c.Pc(4,"coreFormatDate"),c.Pc(5,"translate"),c.Dc(),c.Dc()),2&e){const e=c.Oc(2).$implicit;c.lc(3),c.sd(" ",c.Rc(4,2,1e3*e.timestamp,"strftimetime")," ",c.Rc(5,5,"addon.mod_chat.messagebeepseveryone",c.ad(8,_c0,e.userfullname))," ")}}function AddonModChatChatPage_ng_container_13_div_2_ion_badge_4_Template(e,n){if(1&e&&(c.Ec(0,"ion-badge",30),c.Ec(1,"span"),c.zc(2,"ion-icon",31),c.pd(3),c.Pc(4,"coreFormatDate"),c.Pc(5,"translate"),c.Dc(),c.Dc()),2&e){const e=c.Oc(2).$implicit;c.lc(3),c.sd(" ",c.Rc(4,2,1e3*e.timestamp,"strftimetime")," ",c.Rc(5,5,"addon.mod_chat.messagebeepsyou",c.ad(8,_c0,e.userfullname))," ")}}function AddonModChatChatPage_ng_container_13_div_2_ion_badge_5_Template(e,n){if(1&e&&(c.Ec(0,"ion-badge",32),c.Ec(1,"span"),c.zc(2,"ion-icon",31),c.pd(3),c.Pc(4,"coreFormatDate"),c.Pc(5,"translate"),c.Dc(),c.Dc()),2&e){const e=c.Oc(2).$implicit;c.lc(3),c.sd(" ",c.Rc(4,2,1e3*e.timestamp,"strftimetime")," ",c.Rc(5,5,"addon.mod_chat.messageyoubeep",c.ad(8,_c0,e.beepWho))," ")}}function AddonModChatChatPage_ng_container_13_div_2_ion_badge_6_Template(e,n){if(1&e){const e=c.Fc();c.Ec(0,"ion-badge",33),c.Ec(1,"span"),c.zc(2,"ion-icon",34),c.pd(3),c.Pc(4,"coreFormatDate"),c.Ec(5,"strong"),c.pd(6),c.Ec(7,"core-format-text",35),c.Mc("afterRender",(function AddonModChatChatPage_ng_container_13_div_2_ion_badge_6_Template_core_format_text_afterRender_7_listener(){c.fd(e);const n=c.Oc(2).last,t=c.Oc();return n&&t.scrollToBottom()})),c.Dc(),c.Dc(),c.Dc(),c.Dc()}if(2&e){const e=c.Oc(2).$implicit,n=c.Oc();c.lc(3),c.rd(" ",c.Rc(4,5,1e3*e.timestamp,"strftimetime")," "),c.lc(3),c.rd(" ",e.userfullname," "),c.lc(1),c.Vc("text",e.message)("contextInstanceId",n.cmId)("courseId",n.courseId)}}function AddonModChatChatPage_ng_container_13_div_2_Template(e,n){if(1&e&&(c.Ec(0,"div",20),c.nd(1,AddonModChatChatPage_ng_container_13_div_2_ion_badge_1_Template,6,10,"ion-badge",21),c.nd(2,AddonModChatChatPage_ng_container_13_div_2_ion_badge_2_Template,6,10,"ion-badge",22),c.nd(3,AddonModChatChatPage_ng_container_13_div_2_ion_badge_3_Template,6,10,"ion-badge",23),c.nd(4,AddonModChatChatPage_ng_container_13_div_2_ion_badge_4_Template,6,10,"ion-badge",23),c.nd(5,AddonModChatChatPage_ng_container_13_div_2_ion_badge_5_Template,6,10,"ion-badge",24),c.nd(6,AddonModChatChatPage_ng_container_13_div_2_ion_badge_6_Template,8,8,"ion-badge",25),c.Dc()),2&e){const e=c.Oc().$implicit,n=c.Oc();c.lc(1),c.Vc("ngIf",e.system&&"enter"==e.message),c.lc(1),c.Vc("ngIf",e.system&&"exit"==e.message),c.lc(1),c.Vc("ngIf","all"==e.beep),c.lc(1),c.Vc("ngIf",e.userid!=n.currentUserId&&e.beep==n.currentUserId),c.lc(1),c.Vc("ngIf",e.userid==n.currentUserId&&e.beep&&"all"!=e.beep),c.lc(1),c.Vc("ngIf",!e.system&&!e.beep)}}function AddonModChatChatPage_ng_container_13_ion_item_3_h2_2_Template(e,n){if(1&e&&(c.Ec(0,"h2",40),c.zc(1,"core-user-avatar",41),c.Ec(2,"div"),c.pd(3),c.Dc(),c.Dc()),2&e){const e=c.Oc(2).$implicit;c.lc(1),c.Vc("user",e)("linkProfile",!1),c.lc(2),c.qd(e.userfullname)}}function AddonModChatChatPage_ng_container_13_ion_item_3_div_8_Template(e,n){1&e&&c.zc(0,"div",42)}function AddonModChatChatPage_ng_container_13_ion_item_3_Template(e,n){if(1&e){const e=c.Fc();c.Ec(0,"ion-item",36),c.Ec(1,"ion-label"),c.nd(2,AddonModChatChatPage_ng_container_13_ion_item_3_h2_2_Template,4,3,"h2",37),c.Ec(3,"div",38),c.Ec(4,"core-format-text",35),c.Mc("afterRender",(function AddonModChatChatPage_ng_container_13_ion_item_3_Template_core_format_text_afterRender_4_listener(){c.fd(e);const n=c.Oc().last,t=c.Oc();return n&&t.scrollToBottom()})),c.Dc(),c.Dc(),c.Dc(),c.Ec(5,"ion-note",3),c.pd(6),c.Pc(7,"coreFormatDate"),c.Dc(),c.nd(8,AddonModChatChatPage_ng_container_13_ion_item_3_div_8_Template,1,0,"div",39),c.Dc()}if(2&e){const e=c.Oc().$implicit,n=c.Oc();c.qc("addon-message-mine",e.userid==n.currentUserId)("addon-message-not-mine",e.userid!=n.currentUserId)("addon-message-no-user",!e.showUserData),c.Vc("@coreSlideInOut",e.userid==n.currentUserId?"":"fromLeft"),c.lc(2),c.Vc("ngIf",e.showUserData),c.lc(2),c.Vc("text",e.message)("contextInstanceId",n.cmId)("courseId",n.courseId),c.lc(2),c.qd(c.Rc(7,13,1e3*e.timestamp,"strftimetime")),c.lc(2),c.Vc("ngIf",e.showTail)}}function AddonModChatChatPage_ng_container_13_Template(e,n){if(1&e&&(c.Cc(0),c.nd(1,AddonModChatChatPage_ng_container_13_p_1_Template,3,4,"p",16),c.nd(2,AddonModChatChatPage_ng_container_13_div_2_Template,7,6,"div",17),c.nd(3,AddonModChatChatPage_ng_container_13_ion_item_3_Template,9,16,"ion-item",18),c.Bc()),2&e){const e=n.$implicit;c.lc(1),c.Vc("ngIf",e.showDate),c.lc(1),c.Vc("ngIf",e.special),c.lc(1),c.Vc("ngIf",!e.special)}}function AddonModChatChatPage_core_empty_box_14_Template(e,n){1&e&&(c.zc(0,"core-empty-box",43),c.Pc(1,"translate")),2&e&&c.Vc("message",c.Qc(1,1,"addon.mod_chat.nomessages"))}function AddonModChatChatPage_p_17_Template(e,n){1&e&&(c.Ec(0,"p",44),c.pd(1),c.Pc(2,"translate"),c.Dc()),2&e&&(c.lc(1),c.rd(" ",c.Qc(2,1,"addon.mod_chat.mustbeonlinetosendmessages")," "))}function AddonModChatChatPage_core_send_message_form_18_Template(e,n){if(1&e){const e=c.Fc();c.Ec(0,"core-send-message-form",45),c.Mc("onSubmit",(function AddonModChatChatPage_core_send_message_form_18_Template_core_send_message_form_onSubmit_0_listener(n){c.fd(e);return c.Oc().sendMessage(n)})),c.Pc(1,"translate"),c.Dc()}if(2&e){const e=c.Oc();c.Vc("sendDisabled",e.sending)("message",e.newMessage)("placeholder",c.Qc(1,3,"addon.messages.newmessage"))}}function AddonModChatChatPage_ion_button_19_Template(e,n){if(1&e){const e=c.Fc();c.Ec(0,"ion-button",46),c.Mc("click",(function AddonModChatChatPage_ion_button_19_Template_ion_button_click_0_listener(){c.fd(e);return c.Oc().reconnect()})),c.pd(1),c.Pc(2,"translate"),c.Dc()}2&e&&(c.lc(1),c.rd(" ",c.Qc(2,1,"core.login.reconnect")," "))}let z=(()=>{class AddonModChatChatPage{constructor(){this.loaded=!1,this.title="",this.messages=[],this.sending=!1,this.lastTime=0,this.oldContentHeight=0,this.viewDestroyed=!1,this.pollingRunning=!1,this.users=[],this.currentUserId=b.b.getCurrentSiteUserId(),this.isOnline=C.a.isOnline(),this.onlineSubscription=I.B.onChange().subscribe((()=>{I.C.run((()=>{this.isOnline=C.a.isOnline()}))}))}ngOnInit(){return Object(p.a)(this,void 0,void 0,(function*(){try{this.courseId=P.a.getRequiredRouteNumberParam("courseId"),this.cmId=P.a.getRequiredRouteNumberParam("cmId"),this.chatId=P.a.getRequiredRouteNumberParam("chatId"),this.title=P.a.getRouteParam("title")||"",yield this.loginUser(),yield this.fetchMessages(),this.startPolling()}catch(e){O.a.showErrorModalDefault(e,"addon.mod_chat.errorwhileconnecting",!0),P.a.back()}finally{this.loaded=!0}}))}ionViewDidEnter(){this.startPolling()}ionViewWillLeave(){x.b.trigger(x.b.ACTIVITY_DATA_SENT,{module:"chat"}),this.stopPolling()}loginUser(){return Object(p.a)(this,void 0,void 0,(function*(){this.sessionId=yield D.a.loginUser(this.chatId)}))}fetchMessages(){return Object(p.a)(this,void 0,void 0,(function*(){const e=yield D.a.getLatestMessages(this.sessionId,this.lastTime);this.lastTime=e.chatnewlasttime||0;const n=yield D.a.getMessagesUserData(e.messages,this.courseId);if(!n.length)return;const t=this.messages.length;this.messages=this.messages.concat(n);for(let e=t;e<this.messages.length;e++){this.messages[e]=w.a.formatMessage(this.currentUserId,this.messages[e],e>0?this.messages[e-1]:void 0);const n=this.messages[e];n.beep&&n.beep!=String(this.currentUserId)&&this.loadMessageBeepWho(n)}this.messages[this.messages.length-1].showTail=!0,this.scrollToBottom()}))}loadMessageBeepWho(e){return Object(p.a)(this,void 0,void 0,(function*(){e.beepWho=yield this.getUserFullname(e.beep)}))}showChatUsers(){var e;return Object(p.a)(this,void 0,void 0,(function*(){const n=yield O.a.openSideModal({component:A.a,componentProps:{sessionId:this.sessionId,cmId:this.cmId}});n&&(n.talkTo&&(this.newMessage=`To ${n.talkTo}: `+((null===(e=this.sendMessageForm)||void 0===e?void 0:e.message)||"")),n.beepTo&&this.sendMessage("",n.beepTo),this.users=n.users)}))}getUserFullname(e){return Object(p.a)(this,void 0,void 0,(function*(){const n=parseInt(e,10);if(isNaN(n))return e;const t=this.users.find((e=>e.id==n));if(t)return t.fullname;try{const t=yield D.a.getChatUsers(this.sessionId,{cmId:this.cmId});this.users=t.users;const o=this.users.find((e=>e.id==n));return o?o.fullname:e}catch(n){return e}}))}startPolling(){this.polling||(this.polling=window.setInterval((()=>{v.a.ignoreErrors(this.fetchMessagesInterval())}),D.b.POLL_INTERVAL))}stopPolling(){clearInterval(this.polling),this.polling=void 0}fetchMessagesInterval(){return Object(p.a)(this,void 0,void 0,(function*(){if(this.isOnline&&!this.pollingRunning){this.pollingRunning=!0;try{yield this.fetchMessages()}catch(e){try{yield this.loginUser(),yield this.fetchMessages()}catch(e){throw this.stopPolling(),O.a.showErrorModalDefault(e,"addon.mod_chat.errorwhileretrievingmessages",!0),e}}finally{this.pollingRunning=!1}}}))}sendMessage(e,n=0){return Object(p.a)(this,void 0,void 0,(function*(){if(this.isOnline&&(0!==n||e.trim())){this.sending=!0;try{yield D.a.sendMessage(this.sessionId,e,n),v.a.ignoreErrors(this.fetchMessagesInterval())}catch(n){C.a.closeKeyboard(),this.newMessage=e,O.a.showErrorModalDefault(n,"addon.mod_chat.errorwhilesendingmessage",!0)}finally{this.sending=!1}}}))}reconnect(){return Object(p.a)(this,void 0,void 0,(function*(){const e=yield O.a.showModalLoading();try{yield this.fetchMessagesInterval(),this.startPolling()}catch(e){}finally{e.dismiss()}}))}scrollToBottom(){var e;return Object(p.a)(this,void 0,void 0,(function*(){yield v.a.nextTick(),this.viewDestroyed||null===(e=this.content)||void 0===e||e.scrollToBottom()}))}canLeave(){return Object(p.a)(this,void 0,void 0,(function*(){return!this.messages.some((e=>!e.special))||(yield O.a.showConfirm(I.M.instant("addon.mod_chat.confirmloss")),!0)}))}ngOnDestroy(){this.onlineSubscription&&this.onlineSubscription.unsubscribe(),this.stopPolling(),this.viewDestroyed=!0}}return AddonModChatChatPage.ɵfac=function AddonModChatChatPage_Factory(e){return new(e||AddonModChatChatPage)},AddonModChatChatPage.ɵcmp=c.sc({type:AddonModChatChatPage,selectors:[["page-addon-mod-chat-chat"]],viewQuery:function AddonModChatChatPage_Query(e,n){var t;(1&e&&(c.ud(r.v,!0),c.ud(M.a,!0)),2&e)&&(c.dd(t=c.Nc())&&(n.content=t.first),c.dd(t=c.Nc())&&(n.sendMessageForm=t.first))},decls:20,vars:14,consts:[["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end"],["fill","clear",3,"click",4,"ngIf"],[3,"hideUntil"],["aria-live","polite",1,"addon-messages-discussion-container"],[4,"ngFor","ngForOf"],["icon","far-comments",3,"message",4,"ngIf"],[1,"footer-adjustable"],[3,"color"],["class","ion-text-center",4,"ngIf"],[3,"sendDisabled","message","placeholder","onSubmit",4,"ngIf"],["expand","block","fill","outline",3,"click",4,"ngIf"],["fill","clear",3,"click"],["name","fas-users","slot","icon-only","aria-hidden","true"],["class","ion-text-center addon-messages-date",4,"ngIf"],["class","ion-text-center addon-mod_chat-notice",4,"ngIf"],["class","ion-text-wrap addon-message",3,"addon-message-mine","addon-message-not-mine","addon-message-no-user",4,"ngIf"],[1,"ion-text-center","addon-messages-date"],[1,"ion-text-center","addon-mod_chat-notice"],["class","ion-text-wrap","color","success",4,"ngIf"],["class","ion-text-wrap","color","danger",4,"ngIf"],["class","ion-text-wrap","color","primary",4,"ngIf"],["class","ion-text-wrap","color","light",4,"ngIf"],["class","ion-text-wrap","color","info",4,"ngIf"],["color","success",1,"ion-text-wrap"],["name","fas-sign-in-alt","aria-hidden","true"],["color","danger",1,"ion-text-wrap"],["name","fas-sign-out-alt","aria-hidden","true"],["color","primary",1,"ion-text-wrap"],["name","fas-bell","aria-hidden","true"],["color","light",1,"ion-text-wrap"],["color","info",1,"ion-text-wrap"],["name","fas-asterisk","aria-hidden","true"],["contextLevel","module",3,"text","contextInstanceId","courseId","afterRender"],[1,"ion-text-wrap","addon-message"],["class","addon-message-user",4,"ngIf"],[1,"addon-message-text"],["class","tail",4,"ngIf"],[1,"addon-message-user"],["slot","start",3,"user","linkProfile"],[1,"tail"],["icon","far-comments",3,"message"],[1,"ion-text-center"],[3,"sendDisabled","message","placeholder","onSubmit"],["expand","block","fill","outline",3,"click"]],template:function AddonModChatChatPage_Template(e,n){1&e&&(c.Ec(0,"ion-header"),c.Ec(1,"ion-toolbar"),c.Ec(2,"ion-buttons",0),c.zc(3,"ion-back-button",1),c.Pc(4,"translate"),c.Dc(),c.Ec(5,"ion-title"),c.Ec(6,"h1"),c.zc(7,"core-format-text",2),c.Dc(),c.Dc(),c.Ec(8,"ion-buttons",3),c.nd(9,AddonModChatChatPage_ion_button_9_Template,3,3,"ion-button",4),c.Dc(),c.Dc(),c.Dc(),c.Ec(10,"ion-content"),c.Ec(11,"core-loading",5),c.Ec(12,"ion-list",6),c.nd(13,AddonModChatChatPage_ng_container_13_Template,4,3,"ng-container",7),c.Dc(),c.nd(14,AddonModChatChatPage_core_empty_box_14_Template,2,3,"core-empty-box",8),c.Dc(),c.Dc(),c.Ec(15,"ion-footer",9),c.Ec(16,"ion-toolbar",10),c.nd(17,AddonModChatChatPage_p_17_Template,3,3,"p",11),c.nd(18,AddonModChatChatPage_core_send_message_form_18_Template,2,5,"core-send-message-form",12),c.nd(19,AddonModChatChatPage_ion_button_19_Template,3,3,"ion-button",13),c.Dc(),c.Dc()),2&e&&(c.lc(3),c.Vc("text",c.Qc(4,12,"core.back")),c.lc(4),c.Vc("text",n.title)("contextInstanceId",n.cmId)("courseId",n.courseId),c.lc(2),c.Vc("ngIf",n.loaded),c.lc(2),c.Vc("hideUntil",n.loaded),c.lc(2),c.Vc("ngForOf",n.messages),c.lc(1),c.Vc("ngIf",!n.messages||n.messages.length<=0),c.lc(2),c.Vc("color",n.isOnline&&n.polling&&n.loaded?"contrast":"light"),c.lc(1),c.Vc("ngIf",!n.isOnline),c.lc(1),c.Vc("ngIf",n.isOnline&&n.polling&&n.loaded),c.lc(1),c.Vc("ngIf",n.isOnline&&!n.polling&&n.loaded))},directives:[r.C,r.Ab,r.m,r.h,r.i,r.yb,l.a,y.t,m.a,r.v,T.a,r.P,y.s,r.A,E.a,r.l,r.D,S.a,r.k,r.I,r.O,r.W,k.a,R.a,M.a],pipes:[_.d,V.a],styles:['.ios[_nghost-%COMP%]   ion-footer[_ngcontent-%COMP%]   .toolbar[_ngcontent-%COMP%]:last-child, .ios   [_nghost-%COMP%]   ion-footer[_ngcontent-%COMP%]   .toolbar[_ngcontent-%COMP%]:last-child{padding-bottom:4px;min-height:0}ion-content[_ngcontent-%COMP%]{--content-background:var(--background-alternative);--background:var(--content-background)}ion-content[_ngcontent-%COMP%]::part(scroll){padding-bottom:0!important}.addon-messages-discussion-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding-bottom:16px!important;background:var(--content-background)}.addon-messages-date[_ngcontent-%COMP%]{font-weight:400;font-size:.9rem}ion-item.addon-message[_ngcontent-%COMP%]{--message-background:var(--addon-messages-message-bg);--message-activated-background:var(--addon-messages-message-activated-bg);--message-alignment:flex-start;border:0;border-radius:var(--medium-radius);padding:0 8px;margin:8px;--background:var(--message-background);background:var(--message-background);align-self:var(--message-alignment);width:90%;max-width:var(--list-item-max-width);--min-height:var(--a11y-min-target-size);position:relative;transition:width .5s ease-in-out;overflow:visible}ion-item.addon-message[_ngcontent-%COMP%]::part(native){--inner-border-width:0px;--inner-padding-end:0px;padding:0;margin:0}ion-item.addon-message[_ngcontent-%COMP%]:hover{filter:drop-shadow(2px 2px 2px rgba(0,0,0,.3))}ion-item.addon-message[_ngcontent-%COMP%]   core-format-text[_ngcontent-%COMP%] > p[_ngcontent-%COMP%]:only-child{display:inline}ion-item.addon-message[_ngcontent-%COMP%]   .addon-message-user[_ngcontent-%COMP%]{display:flex;flex-direction:row;justify-content:space-between;align-items:center;margin-bottom:.5rem;margin-top:0;color:var(--ion-text-color)}ion-item.addon-message[_ngcontent-%COMP%]   .addon-message-user[_ngcontent-%COMP%]   core-user-avatar[_ngcontent-%COMP%]{display:block;--core-avatar-size:var(--addon-messages-avatar-size);margin:0}ion-item.addon-message[_ngcontent-%COMP%]   .addon-message-user[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]{font-weight:500;flex-grow:1;padding-left:.5rem;padding-right:.5rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}ion-item.addon-message[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]{color:var(--addon-messages-message-note-text);font-size:var(--addon-messages-message-note-font-size);margin:0;padding:8px 0;align-self:flex-start}ion-item.addon-message[tappable][_ngcontent-%COMP%]:active{--message-background:var(--message-activated-background)}ion-item.addon-message[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{margin:0;padding:8px 0}ion-item.addon-message[_ngcontent-%COMP%]   .addon-message-text[_ngcontent-%COMP%]{display:inline-flex}ion-item.addon-message[_ngcontent-%COMP%]   .addon-message-text[_ngcontent-%COMP%]   *[_ngcontent-%COMP%]{color:var(--ion-text-color)}ion-item.addon-message[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%]{content:"";width:0;height:0;position:absolute;touch-action:none;bottom:0;border:.5rem solid transparent;border-bottom:.5rem solid var(--message-background)}ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]{--message-background:var(--addon-messages-message-mine-bg);--message-activated-background:var(--addon-messages-message-mine-activated-bg);--message-alignment:flex-end}ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .spinner[_ngcontent-%COMP%]{float:right;margin:2px -3px -2px 5px}[dir=rtl][_nghost-%COMP%]   ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .spinner[_ngcontent-%COMP%], [dir=rtl]   [_nghost-%COMP%]   ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .spinner[_ngcontent-%COMP%], [dir=rtl][_ngcontent-%COMP%]   ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .spinner[_ngcontent-%COMP%]{float:left}@supports ((-webkit-margin-start:0) or (margin-inline-start:0)) or (-webkit-margin-start:0){ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .spinner[_ngcontent-%COMP%]{margin-left:unset;margin-right:unset;-webkit-margin-start:5px;margin-inline-start:5px;-webkit-margin-end:-3px;margin-inline-end:-3px}}ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .spinner[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{width:16px;height:16px}ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%]{right:-8px;margin-right:-.5rem}[dir=rtl][_nghost-%COMP%]   ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%], [dir=rtl]   [_nghost-%COMP%]   ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%], [dir=rtl][_ngcontent-%COMP%]   ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%]{left:unset;right:unset;left:-8px}@supports ((-webkit-margin-start:0) or (margin-inline-start:0)) or (-webkit-margin-start:0){ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%]{margin-right:unset;-webkit-margin-end:-.5rem;margin-inline-end:-.5rem}}ion-item.addon-message.addon-message-not-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%]{left:-8px;margin-left:-.5rem}[dir=rtl][_nghost-%COMP%]   ion-item.addon-message.addon-message-not-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%], [dir=rtl]   [_nghost-%COMP%]   ion-item.addon-message.addon-message-not-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%], [dir=rtl][_ngcontent-%COMP%]   ion-item.addon-message.addon-message-not-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%]{left:unset;right:unset;right:-8px}@supports ((-webkit-margin-start:0) or (margin-inline-start:0)) or (-webkit-margin-start:0){ion-item.addon-message.addon-message-not-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%]{margin-left:unset;-webkit-margin-start:-.5rem;margin-inline-start:-.5rem}}ion-item.addon-message[_ngcontent-%COMP%]   .addon-messages-delete-button[_ngcontent-%COMP%]{min-height:0;line-height:normal;margin-top:0;margin-bottom:0;height:var(--a11y-min-target-size)!important;align-self:flex-end}ion-item.addon-message[_ngcontent-%COMP%]   .addon-messages-delete-button[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:1.4em;line-height:normal;color:var(--danger)}ion-item.addon-message.addon-message-no-user[_ngcontent-%COMP%]{margin-top:0}[_nghost-%COMP%]   .addon-mod_chat-notice[_ngcontent-%COMP%]{margin-top:8px;margin-bottom:8px}'],data:{animation:[f.a.SLIDE_IN_OUT]}}),AddonModChatChatPage})();var F=t("4pns");function AddonModChatSessionMessagesPage_ng_container_15_div_1_Template(e,n){if(1&e&&(c.Ec(0,"div",10),c.pd(1),c.Pc(2,"coreFormatDate"),c.Dc()),2&e){const e=c.Oc().$implicit;c.lc(1),c.rd(" ",c.Rc(2,1,1e3*e.timestamp,"strftimedayshort")," ")}}const session_messages_c0=function(e){return{$a:e}};function AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_1_Template(e,n){if(1&e&&(c.Ec(0,"ion-badge",17),c.Ec(1,"span"),c.zc(2,"ion-icon",18),c.pd(3),c.Pc(4,"coreFormatDate"),c.Pc(5,"translate"),c.Dc(),c.Dc()),2&e){const e=c.Oc(2).$implicit;c.lc(3),c.sd(" ",c.Rc(4,2,1e3*e.timestamp,"strftimetime")," ",c.Rc(5,5,"addon.mod_chat.messageenter",c.ad(8,session_messages_c0,e.userfullname))," ")}}function AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_2_Template(e,n){if(1&e&&(c.Ec(0,"ion-badge",19),c.Ec(1,"span"),c.zc(2,"ion-icon",20),c.pd(3),c.Pc(4,"coreFormatDate"),c.Pc(5,"translate"),c.Dc(),c.Dc()),2&e){const e=c.Oc(2).$implicit;c.lc(3),c.sd(" ",c.Rc(4,2,1e3*e.timestamp,"strftimetime")," ",c.Rc(5,5,"addon.mod_chat.messageexit",c.ad(8,session_messages_c0,e.userfullname))," ")}}function AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_3_Template(e,n){if(1&e&&(c.Ec(0,"ion-badge",21),c.Ec(1,"span"),c.zc(2,"ion-icon",22),c.pd(3),c.Pc(4,"coreFormatDate"),c.Pc(5,"translate"),c.Dc(),c.Dc()),2&e){const e=c.Oc(2).$implicit;c.lc(3),c.sd(" ",c.Rc(4,2,1e3*e.timestamp,"strftimetime")," ",c.Rc(5,5,"addon.mod_chat.messagebeepseveryone",c.ad(8,session_messages_c0,e.userfullname))," ")}}function AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_4_Template(e,n){if(1&e&&(c.Ec(0,"ion-badge",21),c.Ec(1,"span"),c.zc(2,"ion-icon",22),c.pd(3),c.Pc(4,"coreFormatDate"),c.Pc(5,"translate"),c.Dc(),c.Dc()),2&e){const e=c.Oc(2).$implicit;c.lc(3),c.sd(" ",c.Rc(4,2,1e3*e.timestamp,"strftimetime")," ",c.Rc(5,5,"addon.mod_chat.messagebeepsyou",c.ad(8,session_messages_c0,e.userfullname))," ")}}function AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_5_Template(e,n){if(1&e&&(c.Ec(0,"ion-badge",23),c.Ec(1,"span"),c.zc(2,"ion-icon",22),c.pd(3),c.Pc(4,"coreFormatDate"),c.Pc(5,"translate"),c.Dc(),c.Dc()),2&e){const e=c.Oc(2).$implicit;c.lc(3),c.sd(" ",c.Rc(4,2,1e3*e.timestamp,"strftimetime")," ",c.Rc(5,5,"addon.mod_chat.messageyoubeep",c.ad(8,session_messages_c0,e.beepWho))," ")}}function AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_6_Template(e,n){if(1&e&&(c.Ec(0,"ion-badge",24),c.Ec(1,"span"),c.zc(2,"ion-icon",25),c.pd(3),c.Pc(4,"coreFormatDate"),c.Ec(5,"strong"),c.pd(6),c.zc(7,"core-format-text",26),c.Dc(),c.Dc(),c.Dc()),2&e){const e=c.Oc(2).$implicit,n=c.Oc();c.lc(3),c.rd(" ",c.Rc(4,5,1e3*e.timestamp,"strftimetime")," "),c.lc(3),c.rd(" ",e.userfullname," "),c.lc(1),c.Vc("text",e.message)("contextInstanceId",n.cmId)("courseId",n.courseId)}}function AddonModChatSessionMessagesPage_ng_container_15_div_2_Template(e,n){if(1&e&&(c.Ec(0,"div",11),c.nd(1,AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_1_Template,6,10,"ion-badge",12),c.nd(2,AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_2_Template,6,10,"ion-badge",13),c.nd(3,AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_3_Template,6,10,"ion-badge",14),c.nd(4,AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_4_Template,6,10,"ion-badge",14),c.nd(5,AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_5_Template,6,10,"ion-badge",15),c.nd(6,AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_6_Template,8,8,"ion-badge",16),c.Dc()),2&e){const e=c.Oc().$implicit,n=c.Oc();c.lc(1),c.Vc("ngIf",e.issystem&&"enter"==e.message),c.lc(1),c.Vc("ngIf",e.issystem&&"exit"==e.message),c.lc(1),c.Vc("ngIf","all"==e.beep),c.lc(1),c.Vc("ngIf",e.userid!=n.currentUserId&&e.beep==n.currentUserId),c.lc(1),c.Vc("ngIf",e.userid==n.currentUserId&&e.beep&&"all"!=e.beep),c.lc(1),c.Vc("ngIf",!e.issystem&&!e.beep)}}function AddonModChatSessionMessagesPage_ng_container_15_ion_item_3_core_user_avatar_3_Template(e,n){if(1&e&&c.zc(0,"core-user-avatar",34),2&e){const e=c.Oc(2).$implicit;c.Vc("user",e)("linkProfile",!1)}}function AddonModChatSessionMessagesPage_ng_container_15_ion_item_3_div_4_Template(e,n){if(1&e&&(c.Ec(0,"div"),c.pd(1),c.Dc()),2&e){const e=c.Oc(2).$implicit;c.lc(1),c.qd(e.userfullname)}}function AddonModChatSessionMessagesPage_ng_container_15_ion_item_3_div_10_Template(e,n){1&e&&c.zc(0,"div",35)}function AddonModChatSessionMessagesPage_ng_container_15_ion_item_3_Template(e,n){if(1&e&&(c.Ec(0,"ion-item",27),c.Ec(1,"ion-label"),c.Ec(2,"h2",28),c.nd(3,AddonModChatSessionMessagesPage_ng_container_15_ion_item_3_core_user_avatar_3_Template,1,2,"core-user-avatar",29),c.nd(4,AddonModChatSessionMessagesPage_ng_container_15_ion_item_3_div_4_Template,2,1,"div",30),c.Dc(),c.Ec(5,"div",31),c.zc(6,"core-format-text",26),c.Dc(),c.Dc(),c.Ec(7,"ion-note",32),c.pd(8),c.Pc(9,"coreFormatDate"),c.Dc(),c.nd(10,AddonModChatSessionMessagesPage_ng_container_15_ion_item_3_div_10_Template,1,0,"div",33),c.Dc()),2&e){const e=c.Oc().$implicit,n=c.Oc();c.qc("addon-message-mine",e.userid==n.currentUserId)("addon-message-not-mine",e.userid!=n.currentUserId)("addon-message-no-user",!e.showUserData),c.lc(3),c.Vc("ngIf",e.showUserData),c.lc(1),c.Vc("ngIf",e.showUserData),c.lc(2),c.Vc("text",e.message)("contextInstanceId",n.cmId)("courseId",n.courseId),c.lc(2),c.qd(c.Rc(9,13,1e3*e.timestamp,"strftimetime")),c.lc(2),c.Vc("ngIf",e.showTail)}}function AddonModChatSessionMessagesPage_ng_container_15_Template(e,n){if(1&e&&(c.Cc(0),c.nd(1,AddonModChatSessionMessagesPage_ng_container_15_div_1_Template,3,4,"div",7),c.nd(2,AddonModChatSessionMessagesPage_ng_container_15_div_2_Template,7,6,"div",8),c.nd(3,AddonModChatSessionMessagesPage_ng_container_15_ion_item_3_Template,11,16,"ion-item",9),c.Bc()),2&e){const e=n.$implicit;c.lc(1),c.Vc("ngIf",e.showDate),c.lc(1),c.Vc("ngIf",e.special),c.lc(1),c.Vc("ngIf",!e.special)}}let U=(()=>{class AddonModChatSessionMessagesPage{constructor(){this.messages=[],this.loaded=!1}ngOnInit(){try{this.courseId=P.a.getRequiredRouteNumberParam("courseId"),this.cmId=P.a.getRequiredRouteNumberParam("cmId"),this.sessionStart=P.a.getRequiredRouteNumberParam("sessionStart"),this.sessionEnd=P.a.getRequiredRouteNumberParam("sessionEnd"),this.chatId=P.a.getRequiredRouteNumberParam("chatId"),this.groupId=P.a.getRouteNumberParam("groupId")||0}catch(e){return O.a.showErrorModal(e),P.a.back(),void 0}this.currentUserId=b.b.getCurrentSiteUserId(),this.fetchMessages()}fetchMessages(){return Object(p.a)(this,void 0,void 0,(function*(){try{const e=yield D.a.getSessionMessages(this.chatId,this.sessionStart,this.sessionEnd,this.groupId,{cmId:this.cmId});this.messages=yield D.a.getMessagesUserData(e,this.courseId);for(let e=0;e<this.messages.length;e++){this.messages[e]=w.a.formatMessage(this.currentUserId,this.messages[e],e>0?this.messages[e-1]:void 0);const n=this.messages[e];n.beep&&n.beep!=String(this.currentUserId)&&this.loadMessageBeepWho(n)}this.messages[this.messages.length-1].showTail=!0}catch(e){O.a.showErrorModalDefault(e,"core.errorloadingcontent",!0)}finally{this.loaded=!0}}))}loadMessageBeepWho(e){return Object(p.a)(this,void 0,void 0,(function*(){e.beepWho=yield this.getUserFullname(e.beep)}))}getUserFullname(e){return Object(p.a)(this,void 0,void 0,(function*(){const n=parseInt(e,10);if(isNaN(n))return e;try{return(yield F.a.getProfile(n,this.courseId,!0)).fullname}catch(n){return e}}))}refreshMessages(e){return Object(p.a)(this,void 0,void 0,(function*(){try{yield v.a.ignoreErrors(D.a.invalidateSessionMessages(this.chatId,this.sessionStart,this.groupId)),yield this.fetchMessages()}finally{e.complete()}}))}}return AddonModChatSessionMessagesPage.ɵfac=function AddonModChatSessionMessagesPage_Factory(e){return new(e||AddonModChatSessionMessagesPage)},AddonModChatSessionMessagesPage.ɵcmp=c.sc({type:AddonModChatSessionMessagesPage,selectors:[["page-addon-mod-chat-session-messages"]],decls:16,vars:12,consts:[["slot","start"],[3,"text"],["slot","fixed",3,"disabled","ionRefresh"],[3,"pullingText"],[3,"hideUntil"],[1,"addon-messages-discussion-container"],[4,"ngFor","ngForOf"],["class","ion-text-center addon-messages-date",4,"ngIf"],["class","ion-text-center addon-mod_chat-notice",4,"ngIf"],["class","ion-text-wrap addon-message",3,"addon-message-mine","addon-message-not-mine","addon-message-no-user",4,"ngIf"],[1,"ion-text-center","addon-messages-date"],[1,"ion-text-center","addon-mod_chat-notice"],["class","ion-text-wrap","color","success",4,"ngIf"],["class","ion-text-wrap","color","danger",4,"ngIf"],["class","ion-text-wrap","color","primary",4,"ngIf"],["class","ion-text-wrap","color","light",4,"ngIf"],["class","ion-text-wrap","color","info",4,"ngIf"],["color","success",1,"ion-text-wrap"],["name","fas-sign-in-alt","aria-hidden","true"],["color","danger",1,"ion-text-wrap"],["name","fas-sign-out-alt","aria-hidden","true"],["color","primary",1,"ion-text-wrap"],["name","fas-bell","aria-hidden","true"],["color","light",1,"ion-text-wrap"],["color","info",1,"ion-text-wrap"],["name","fas-asterisk","aria-hidden","true"],["contextLevel","module",3,"text","contextInstanceId","courseId"],[1,"ion-text-wrap","addon-message"],[1,"addon-message-user"],["slot","start",3,"user","linkProfile",4,"ngIf"],[4,"ngIf"],[1,"addon-message-text"],["slot","end"],["class","tail",4,"ngIf"],["slot","start",3,"user","linkProfile"],[1,"tail"]],template:function AddonModChatSessionMessagesPage_Template(e,n){1&e&&(c.Ec(0,"ion-header"),c.Ec(1,"ion-toolbar"),c.Ec(2,"ion-buttons",0),c.zc(3,"ion-back-button",1),c.Pc(4,"translate"),c.Dc(),c.Ec(5,"ion-title"),c.Ec(6,"h1"),c.pd(7),c.Pc(8,"translate"),c.Dc(),c.Dc(),c.Dc(),c.Dc(),c.Ec(9,"ion-content"),c.Ec(10,"ion-refresher",2),c.Mc("ionRefresh",(function AddonModChatSessionMessagesPage_Template_ion_refresher_ionRefresh_10_listener(e){return n.refreshMessages(e.target)})),c.zc(11,"ion-refresher-content",3),c.Pc(12,"translate"),c.Dc(),c.Ec(13,"core-loading",4),c.Ec(14,"ion-list",5),c.nd(15,AddonModChatSessionMessagesPage_ng_container_15_Template,4,3,"ng-container",6),c.Dc(),c.Dc(),c.Dc()),2&e&&(c.lc(3),c.Vc("text",c.Qc(4,6,"core.back")),c.lc(4),c.qd(c.Qc(8,8,"addon.mod_chat.messages")),c.lc(3),c.Vc("disabled",!n.loaded),c.lc(1),c.Wc("pullingText",c.Qc(12,10,"core.pulltorefresh")),c.lc(2),c.Vc("hideUntil",n.loaded),c.lc(2),c.Vc("ngForOf",n.messages))},directives:[r.C,r.Ab,r.m,r.h,r.i,r.yb,m.a,r.v,r.bb,r.cb,T.a,r.P,y.s,y.t,r.k,r.D,S.a,l.a,r.I,r.O,r.W,k.a],pipes:[_.d,V.a],styles:['.ios[_nghost-%COMP%]   ion-footer[_ngcontent-%COMP%]   .toolbar[_ngcontent-%COMP%]:last-child, .ios   [_nghost-%COMP%]   ion-footer[_ngcontent-%COMP%]   .toolbar[_ngcontent-%COMP%]:last-child{padding-bottom:4px;min-height:0}ion-content[_ngcontent-%COMP%]{--content-background:var(--background-alternative);--background:var(--content-background)}ion-content[_ngcontent-%COMP%]::part(scroll){padding-bottom:0!important}.addon-messages-discussion-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding-bottom:16px!important;background:var(--content-background)}.addon-messages-date[_ngcontent-%COMP%]{font-weight:400;font-size:.9rem}ion-item.addon-message[_ngcontent-%COMP%]{--message-background:var(--addon-messages-message-bg);--message-activated-background:var(--addon-messages-message-activated-bg);--message-alignment:flex-start;border:0;border-radius:var(--medium-radius);padding:0 8px;margin:8px;--background:var(--message-background);background:var(--message-background);align-self:var(--message-alignment);width:90%;max-width:var(--list-item-max-width);--min-height:var(--a11y-min-target-size);position:relative;transition:width .5s ease-in-out;overflow:visible}ion-item.addon-message[_ngcontent-%COMP%]::part(native){--inner-border-width:0px;--inner-padding-end:0px;padding:0;margin:0}ion-item.addon-message[_ngcontent-%COMP%]:hover{filter:drop-shadow(2px 2px 2px rgba(0,0,0,.3))}ion-item.addon-message[_ngcontent-%COMP%]   core-format-text[_ngcontent-%COMP%] > p[_ngcontent-%COMP%]:only-child{display:inline}ion-item.addon-message[_ngcontent-%COMP%]   .addon-message-user[_ngcontent-%COMP%]{display:flex;flex-direction:row;justify-content:space-between;align-items:center;margin-bottom:.5rem;margin-top:0;color:var(--ion-text-color)}ion-item.addon-message[_ngcontent-%COMP%]   .addon-message-user[_ngcontent-%COMP%]   core-user-avatar[_ngcontent-%COMP%]{display:block;--core-avatar-size:var(--addon-messages-avatar-size);margin:0}ion-item.addon-message[_ngcontent-%COMP%]   .addon-message-user[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]{font-weight:500;flex-grow:1;padding-left:.5rem;padding-right:.5rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}ion-item.addon-message[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]{color:var(--addon-messages-message-note-text);font-size:var(--addon-messages-message-note-font-size);margin:0;padding:8px 0;align-self:flex-start}ion-item.addon-message[tappable][_ngcontent-%COMP%]:active{--message-background:var(--message-activated-background)}ion-item.addon-message[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{margin:0;padding:8px 0}ion-item.addon-message[_ngcontent-%COMP%]   .addon-message-text[_ngcontent-%COMP%]{display:inline-flex}ion-item.addon-message[_ngcontent-%COMP%]   .addon-message-text[_ngcontent-%COMP%]   *[_ngcontent-%COMP%]{color:var(--ion-text-color)}ion-item.addon-message[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%]{content:"";width:0;height:0;position:absolute;touch-action:none;bottom:0;border:.5rem solid transparent;border-bottom:.5rem solid var(--message-background)}ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]{--message-background:var(--addon-messages-message-mine-bg);--message-activated-background:var(--addon-messages-message-mine-activated-bg);--message-alignment:flex-end}ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .spinner[_ngcontent-%COMP%]{float:right;margin:2px -3px -2px 5px}[dir=rtl][_nghost-%COMP%]   ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .spinner[_ngcontent-%COMP%], [dir=rtl]   [_nghost-%COMP%]   ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .spinner[_ngcontent-%COMP%], [dir=rtl][_ngcontent-%COMP%]   ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .spinner[_ngcontent-%COMP%]{float:left}@supports ((-webkit-margin-start:0) or (margin-inline-start:0)) or (-webkit-margin-start:0){ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .spinner[_ngcontent-%COMP%]{margin-left:unset;margin-right:unset;-webkit-margin-start:5px;margin-inline-start:5px;-webkit-margin-end:-3px;margin-inline-end:-3px}}ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .spinner[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{width:16px;height:16px}ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%]{right:-8px;margin-right:-.5rem}[dir=rtl][_nghost-%COMP%]   ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%], [dir=rtl]   [_nghost-%COMP%]   ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%], [dir=rtl][_ngcontent-%COMP%]   ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%]{left:unset;right:unset;left:-8px}@supports ((-webkit-margin-start:0) or (margin-inline-start:0)) or (-webkit-margin-start:0){ion-item.addon-message.addon-message-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%]{margin-right:unset;-webkit-margin-end:-.5rem;margin-inline-end:-.5rem}}ion-item.addon-message.addon-message-not-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%]{left:-8px;margin-left:-.5rem}[dir=rtl][_nghost-%COMP%]   ion-item.addon-message.addon-message-not-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%], [dir=rtl]   [_nghost-%COMP%]   ion-item.addon-message.addon-message-not-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%], [dir=rtl][_ngcontent-%COMP%]   ion-item.addon-message.addon-message-not-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%]{left:unset;right:unset;right:-8px}@supports ((-webkit-margin-start:0) or (margin-inline-start:0)) or (-webkit-margin-start:0){ion-item.addon-message.addon-message-not-mine[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%]{margin-left:unset;-webkit-margin-start:-.5rem;margin-inline-start:-.5rem}}ion-item.addon-message[_ngcontent-%COMP%]   .addon-messages-delete-button[_ngcontent-%COMP%]{min-height:0;line-height:normal;margin-top:0;margin-bottom:0;height:var(--a11y-min-target-size)!important;align-self:flex-end}ion-item.addon-message[_ngcontent-%COMP%]   .addon-messages-delete-button[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:1.4em;line-height:normal;color:var(--danger)}ion-item.addon-message.addon-message-no-user[_ngcontent-%COMP%]{margin-top:0}[_nghost-%COMP%]   .addon-mod_chat-notice[_ngcontent-%COMP%]{margin-top:8px;margin-bottom:8px}']}),AddonModChatSessionMessagesPage})();var $=t("Y+03"),j=t("vY5A"),Q=t("EoRH"),L=t("baaQ"),q=t("46ml"),N=t("CvRw"),B=t("mWdr");class chat_sessions_source_AddonModChatSessionsSource extends N.a{constructor(e,n,t){super(),this.showAll=!1,this.groupId=0,this.COURSE_ID=e,this.CHAT_ID=n,this.CM_ID=t}invalidateCache(){return Object(p.a)(this,void 0,void 0,(function*(){yield v.a.ignoreErrors(v.a.allPromises([B.a.invalidateActivityGroupInfo(this.CM_ID),D.a.invalidateSessions(this.CHAT_ID,this.groupId,this.showAll)]))}))}loadPageItems(){return Object(p.a)(this,void 0,void 0,(function*(){this.groupInfo=yield B.a.getActivityGroupInfo(this.CM_ID,!1),this.groupId=B.a.validateGroupId(this.groupId,this.groupInfo);const e=yield D.a.getSessions(this.CHAT_ID,this.groupId,this.showAll,{cmId:this.CM_ID}),n=[],t=e.map((e=>(e.duration=e.sessionend-e.sessionstart,e.sessionusers.forEach((e=>{n.push(this.loadUserFullname(e))})),e.allsessionusers=e.sessionusers,e.sessionusers.length>4&&(e.sessionusers=e.allsessionusers.slice(0,3)),e)));return yield Promise.all(n),{items:t}}))}getItemPath(e){return`${e.sessionstart}/${e.sessionend}`}getItemQueryParams(){return{chatId:this.CHAT_ID,groupId:this.groupId}}loadUserFullname(e){return Object(p.a)(this,void 0,void 0,(function*(){if(!e.userfullname)try{const n=yield F.a.getProfile(e.userid,this.COURSE_ID,!0);e.userfullname=n.fullname}catch(n){e.userfullname=I.M.instant("core.deleteduser")+" "+e.userid}}))}}var W=t("3Pt+"),G=t("llyR");function AddonModChatSessionsPage_ion_item_15_ng_container_2_Template(e,n){1&e&&(c.Cc(0),c.pd(1),c.Pc(2,"translate"),c.Bc()),2&e&&(c.lc(1),c.qd(c.Qc(2,1,"core.groupsseparate")))}function AddonModChatSessionsPage_ion_item_15_ng_container_3_Template(e,n){1&e&&(c.Cc(0),c.pd(1),c.Pc(2,"translate"),c.Bc()),2&e&&(c.lc(1),c.qd(c.Qc(2,1,"core.groupsvisible")))}function AddonModChatSessionsPage_ion_item_15_ion_select_option_6_Template(e,n){if(1&e&&(c.Ec(0,"ion-select-option",14),c.pd(1),c.Dc()),2&e){const e=n.$implicit;c.Vc("value",e.id),c.lc(1),c.rd(" ",e.name," ")}}const sessions_c0=function(e){return{header:e}};function AddonModChatSessionsPage_ion_item_15_Template(e,n){if(1&e){const e=c.Fc();c.Ec(0,"ion-item",9),c.Ec(1,"ion-label",10),c.nd(2,AddonModChatSessionsPage_ion_item_15_ng_container_2_Template,3,3,"ng-container",11),c.nd(3,AddonModChatSessionsPage_ion_item_15_ng_container_3_Template,3,3,"ng-container",11),c.Dc(),c.Ec(4,"ion-select",12),c.Mc("ngModelChange",(function AddonModChatSessionsPage_ion_item_15_Template_ion_select_ngModelChange_4_listener(n){c.fd(e);return c.Oc().groupId=n}))("ionChange",(function AddonModChatSessionsPage_ion_item_15_Template_ion_select_ionChange_4_listener(){c.fd(e);return c.Oc().reloadSessions()})),c.Pc(5,"translate"),c.nd(6,AddonModChatSessionsPage_ion_item_15_ion_select_option_6_Template,2,2,"ion-select-option",13),c.Dc(),c.Dc()}if(2&e){const e=c.Oc();c.lc(2),c.Vc("ngIf",e.groupInfo.separateGroups),c.lc(1),c.Vc("ngIf",e.groupInfo.visibleGroups),c.lc(1),c.Vc("ngModel",e.groupId)("interfaceOptions",c.ad(7,sessions_c0,c.Qc(5,5,"core.group"))),c.lc(2),c.Vc("ngForOf",e.groupInfo.groups)}}function AddonModChatSessionsPage_ion_card_21_p_6_Template(e,n){if(1&e&&(c.Ec(0,"p"),c.pd(1),c.Pc(2,"coreDuration"),c.Dc()),2&e){const e=c.Oc().$implicit;c.lc(1),c.qd(c.Qc(2,1,e.duration))}}function AddonModChatSessionsPage_ion_card_21_ion_item_8_span_3_Template(e,n){if(1&e&&(c.Ec(0,"span"),c.pd(1),c.Dc()),2&e){const e=c.Oc().$implicit;c.lc(1),c.rd("(",e.messagecount,")")}}function AddonModChatSessionsPage_ion_card_21_ion_item_8_Template(e,n){if(1&e&&(c.Ec(0,"ion-item"),c.Ec(1,"ion-label"),c.pd(2),c.nd(3,AddonModChatSessionsPage_ion_card_21_ion_item_8_span_3_Template,2,1,"span",11),c.Dc(),c.Dc()),2&e){const e=n.$implicit;c.lc(2),c.rd(" ",e.userfullname," "),c.lc(1),c.Vc("ngIf",e.messagecount)}}function AddonModChatSessionsPage_ion_card_21_ion_button_9_Template(e,n){if(1&e){const e=c.Fc();c.Ec(0,"ion-button",20),c.Mc("click",(function AddonModChatSessionsPage_ion_card_21_ion_button_9_Template_ion_button_click_0_listener(n){c.fd(e);const t=c.Oc().$implicit;return c.Oc().showMoreUsers(t,n)})),c.pd(1),c.Pc(2,"translate"),c.Dc()}2&e&&(c.lc(1),c.rd(" ",c.Qc(2,1,"core.showmore")," "))}function AddonModChatSessionsPage_ion_card_21_Template(e,n){if(1&e){const e=c.Fc();c.Ec(0,"ion-card",15),c.Mc("click",(function AddonModChatSessionsPage_ion_card_21_Template_ion_card_click_0_listener(){c.fd(e);const t=n.$implicit;return c.Oc().sessions.select(t)})),c.Ec(1,"ion-item",16),c.Ec(2,"ion-label"),c.Ec(3,"p",17),c.pd(4),c.Pc(5,"coreFormatDate"),c.Dc(),c.nd(6,AddonModChatSessionsPage_ion_card_21_p_6_Template,3,3,"p",11),c.Dc(),c.Dc(),c.Ec(7,"ion-card-content"),c.nd(8,AddonModChatSessionsPage_ion_card_21_ion_item_8_Template,4,2,"ion-item",18),c.Dc(),c.nd(9,AddonModChatSessionsPage_ion_card_21_ion_button_9_Template,3,3,"ion-button",19),c.Dc()}if(2&e){const e=n.$implicit,t=c.Oc();c.qc("addon-mod-chat-session-show-more",e.sessionusers.length<e.allsessionusers.length),c.mc("aria-current",t.sessions.getItemAriaCurrent(e)),c.lc(4),c.qd(c.Qc(5,7,1e3*e.sessionstart)),c.lc(2),c.Vc("ngIf",e.duration),c.lc(2),c.Vc("ngForOf",e.sessionusers),c.lc(1),c.Vc("ngIf",e.sessionusers.length<e.allsessionusers.length)}}function AddonModChatSessionsPage_core_empty_box_22_Template(e,n){1&e&&(c.zc(0,"core-empty-box",21),c.Pc(1,"translate")),2&e&&c.Vc("message",c.Qc(1,1,"addon.mod_chat.nosessionsfound"))}let H=(()=>{class AddonModChatSessionsPage{constructor(){try{const e=P.a.getRequiredRouteNumberParam("courseId"),n=P.a.getRequiredRouteNumberParam("chatId"),t=P.a.getRequiredRouteNumberParam("cmId"),o=L.a.getOrCreateSource(chat_sessions_source_AddonModChatSessionsSource,[e,n,t]);this.sessions=new Q.a(o,AddonModChatSessionsPage)}catch(e){return O.a.showErrorModal(e),P.a.back(),void 0}}get groupId(){return this.sessions.getSource().groupId}set groupId(e){this.sessions.getSource().groupId=e}get showAll(){return this.sessions.getSource().showAll}set showAll(e){this.sessions.getSource().showAll=e}get groupInfo(){return this.sessions.getSource().groupInfo}ngAfterViewInit(){return Object(p.a)(this,void 0,void 0,(function*(){yield this.fetchSessions(),this.sessions.start(this.splitView)}))}fetchSessions(){return Object(p.a)(this,void 0,void 0,(function*(){try{yield this.sessions.load()}catch(e){O.a.showErrorModalDefault(e,"core.errorloadingcontent",!0)}}))}reloadSessions(){return Object(p.a)(this,void 0,void 0,(function*(){const e=yield O.a.showModalLoading();try{yield this.sessions.reload()}catch(e){O.a.showErrorModalDefault(e,"core.errorloadingcontent",!0)}finally{e.dismiss()}}))}refreshSessions(e){return Object(p.a)(this,void 0,void 0,(function*(){try{this.sessions.getSource().setDirty(!0),yield this.sessions.getSource().invalidateCache(),yield this.fetchSessions()}finally{e.complete()}}))}showMoreUsers(e,n){e.allsessionusers&&(e.sessionusers=e.allsessionusers),n.stopPropagation()}ngOnDestroy(){this.sessions.destroy()}}return AddonModChatSessionsPage.ɵfac=function AddonModChatSessionsPage_Factory(e){return new(e||AddonModChatSessionsPage)},AddonModChatSessionsPage.ɵcmp=c.sc({type:AddonModChatSessionsPage,selectors:[["page-addon-mod-chat-sessions"]],viewQuery:function AddonModChatSessionsPage_Query(e,n){var t;(1&e&&c.ud(q.a,!0),2&e)&&(c.dd(t=c.Nc())&&(n.splitView=t.first))},decls:23,vars:18,consts:[["slot","start"],[3,"text"],["slot","fixed",3,"disabled","ionRefresh"],[3,"pullingText"],[3,"hideUntil"],["class","ion-text-wrap core-group-selector",4,"ngIf"],[3,"ngModel","ngModelChange","ionChange"],["button","",3,"addon-mod-chat-session-show-more","click",4,"ngFor","ngForOf"],["icon","far-comments",3,"message",4,"ngIf"],[1,"ion-text-wrap","core-group-selector"],["id","addon-chat-groupslabel"],[4,"ngIf"],["aria-labelledby","addon-chat-groupslabel","interface","action-sheet",3,"ngModel","interfaceOptions","ngModelChange","ionChange"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["button","",3,"click"],[1,"ion-text-wrap"],[1,"item-heading"],[4,"ngFor","ngForOf"],["fill","clear","expand","block",3,"click",4,"ngIf"],["fill","clear","expand","block",3,"click"],["icon","far-comments",3,"message"]],template:function AddonModChatSessionsPage_Template(e,n){1&e&&(c.Ec(0,"ion-header"),c.Ec(1,"ion-toolbar"),c.Ec(2,"ion-buttons",0),c.zc(3,"ion-back-button",1),c.Pc(4,"translate"),c.Dc(),c.Ec(5,"ion-title"),c.Ec(6,"h1"),c.pd(7),c.Pc(8,"translate"),c.Dc(),c.Dc(),c.Dc(),c.Dc(),c.Ec(9,"ion-content"),c.Ec(10,"core-split-view"),c.Ec(11,"ion-refresher",2),c.Mc("ionRefresh",(function AddonModChatSessionsPage_Template_ion_refresher_ionRefresh_11_listener(e){return n.refreshSessions(e.target)})),c.zc(12,"ion-refresher-content",3),c.Pc(13,"translate"),c.Dc(),c.Ec(14,"core-loading",4),c.nd(15,AddonModChatSessionsPage_ion_item_15_Template,7,9,"ion-item",5),c.Ec(16,"ion-item"),c.Ec(17,"ion-label"),c.pd(18),c.Pc(19,"translate"),c.Dc(),c.Ec(20,"ion-toggle",6),c.Mc("ngModelChange",(function AddonModChatSessionsPage_Template_ion_toggle_ngModelChange_20_listener(e){return n.showAll=e}))("ionChange",(function AddonModChatSessionsPage_Template_ion_toggle_ionChange_20_listener(){return n.reloadSessions()})),c.Dc(),c.Dc(),c.nd(21,AddonModChatSessionsPage_ion_card_21_Template,10,9,"ion-card",7),c.nd(22,AddonModChatSessionsPage_core_empty_box_22_Template,2,3,"core-empty-box",8),c.Dc(),c.Dc(),c.Dc()),2&e&&(c.lc(3),c.Vc("text",c.Qc(4,10,"core.back")),c.lc(4),c.qd(c.Qc(8,12,"addon.mod_chat.chatreport")),c.lc(4),c.Vc("disabled",!n.sessions.loaded),c.lc(1),c.Wc("pullingText",c.Qc(13,14,"core.pulltorefresh")),c.lc(2),c.Vc("hideUntil",n.sessions.loaded),c.lc(1),c.Vc("ngIf",n.groupInfo&&(n.groupInfo.separateGroups||n.groupInfo.visibleGroups)),c.lc(3),c.qd(c.Qc(19,16,"addon.mod_chat.showincompletesessions")),c.lc(2),c.Vc("ngModel",n.showAll),c.lc(1),c.Vc("ngForOf",n.sessions.items),c.lc(1),c.Vc("ngIf",n.sessions.empty))},directives:[r.C,r.Ab,r.m,r.h,r.i,r.yb,m.a,r.v,q.a,r.bb,r.cb,T.a,y.t,r.I,r.O,r.zb,r.d,W.r,W.u,y.s,r.lb,r.Ob,r.mb,r.n,r.o,E.a,r.l,R.a],pipes:[_.d,V.a,G.a],encapsulation:2}),AddonModChatSessionsPage})();var Y=t("MLi9");const J=[{path:":courseId/:cmId",component:h},{path:":courseId/:cmId/chat",component:z,canDeactivate:[Y.a]}],X=[...J,{path:":courseId/:cmId/sessions",component:H},{path:":courseId/:cmId/sessions/:sessionStart/:sessionEnd",component:U}],K=[...J,{path:":courseId/:cmId/sessions",component:H,children:[{path:":sessionStart/:sessionEnd",component:U}]}],Z=[...Object(j.c)(X,(()=>$.a.isMobile)),...Object(j.c)(K,(()=>$.a.isTablet))];let ee=(()=>{class AddonModChatLazyModule{}return AddonModChatLazyModule.ɵmod=c.wc({type:AddonModChatLazyModule}),AddonModChatLazyModule.ɵinj=c.vc({factory:function AddonModChatLazyModule_Factory(e){return new(e||AddonModChatLazyModule)},imports:[[o.m.forChild(Z),s.a,a.a]]}),AddonModChatLazyModule})();void(("undefined"==typeof ngJitMode||ngJitMode)&&c.kd(ee,{declarations:[h,z,H,U],imports:[o.m,s.a,a.a]}))}}]);